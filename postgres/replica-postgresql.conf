# PostgreSQL Replica Configuration for Conecta Plus
# Read-only replica for load distribution

# =============================================================================
# CONNECTION SETTINGS
# =============================================================================
listen_addresses = '*'
port = 5432
max_connections = 400                  # Read-only connections
superuser_reserved_connections = 5

# =============================================================================
# MEMORY SETTINGS (Optimized for reads)
# =============================================================================
shared_buffers = 512MB
effective_cache_size = 1536MB
work_mem = 12MB                         # Higher for read operations
maintenance_work_mem = 64MB
dynamic_shared_memory_type = posix

# =============================================================================
# STANDBY SETTINGS
# =============================================================================
hot_standby = on
hot_standby_feedback = on
max_standby_streaming_delay = -1        # Never cancel queries
max_standby_archive_delay = -1          # Never cancel queries

# =============================================================================
# REPLICATION SETTINGS
# =============================================================================
primary_conninfo = 'host=db-master port=5432 user=replicator password=${POSTGRES_REPLICATION_PASSWORD} application_name=replica1'
primary_slot_name = 'replica_1'
promote_trigger_file = '/var/lib/postgresql/promote'

# Recovery settings
recovery_target_timeline = 'latest'

# =============================================================================
# PERFORMANCE TUNING (Read-optimized)
# =============================================================================
effective_io_concurrency = 200
random_page_cost = 1.1
seq_page_cost = 1.0

# Planner settings (read-optimized)
default_statistics_target = 100
from_collapse_limit = 15
join_collapse_limit = 15
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on

# Parallelism for read queries
max_worker_processes = 8
max_parallel_workers_per_gather = 6    # Higher for read queries
max_parallel_workers = 8

# =============================================================================
# MEMORY FOR COMPLEX QUERIES
# =============================================================================
temp_buffers = 32MB
max_prepared_transactions = 0           # Not needed for replica

# =============================================================================
# LOGGING (Minimal for replica)
# =============================================================================
logging_collector = on
log_destination = 'stderr'
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-replica-%Y-%m-%d_%H%M%S.log'
log_min_duration_statement = 5000      # Log very slow queries only
log_line_prefix = '[REPLICA] %t [%p]: [%l-1] user=%u,db=%d,app=%a '

# =============================================================================
# CONNECTION SETTINGS
# =============================================================================
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3
statement_timeout = 300000              # 5 minutes for complex read queries

# =============================================================================
# AUTHENTICATION
# =============================================================================
ssl = on

# =============================================================================
# LOCALE
# =============================================================================
lc_messages = 'en_US.utf8'
lc_monetary = 'pt_BR.utf8'
lc_numeric = 'pt_BR.utf8'
lc_time = 'pt_BR.utf8'
default_text_search_config = 'pg_catalog.portuguese'
timezone = 'America/Manaus'